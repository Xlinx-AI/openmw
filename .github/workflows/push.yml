name: Build and test

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**' # Prevent duplicate runs; Release workflow handles tags
  pull_request:

# Cancel previous builds on the same branch/PR to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: RelWithDebInfo
  # Enable Unity Build for significantly faster compilation
  # This combines multiple source files into single translation units
  UNITY_BUILD: ON

jobs:
  Output-Envs:
    name: Parse Environment Variables
    runs-on: ubuntu-latest
    outputs:
      VCPKG_DEPS_TAG: ${{ env.VCPKG_DEPS_TAG }}
      BUILD_TYPE: ${{ env.BUILD_TYPE }}
    steps:
      - uses: actions/checkout@v4
      - run: cat "${{ github.workspace }}/CI/github.env" >> $GITHUB_ENV

  Ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        # Combined steps to save startup time
        run: |
          sudo add-apt-repository -y ppa:openmw/openmw
          sudo apt-get update
          sudo apt-get install -y ninja-build
          sudo CI/install_debian_deps.sh gcc openmw-deps openmw-deps-dynamic

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-${{ env.BUILD_TYPE }}-unity
          max-size: 2000M
          verbose: 2

      - name: Configure
        run: >
          cmake -S . -B build -G Ninja
          -D CMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          -D CMAKE_C_COMPILER_LAUNCHER=ccache
          -D CMAKE_CXX_COMPILER_LAUNCHER=ccache
          -D OPENMW_UNITY_BUILD=${{ env.UNITY_BUILD }}
          -D OPENMW_USE_SYSTEM_RECASTNAVIGATION=ON
          -D USE_SYSTEM_TINYXML=ON
          -D BUILD_COMPONENTS_TESTS=ON
          -D BUILD_OPENMW_TESTS=ON
          -D BUILD_OPENCS_TESTS=ON
          -D CMAKE_INSTALL_PREFIX=install

      - name: Build
        run: cmake --build build -- -j$(nproc)

      - name: Run components tests
        working-directory: build
        run: ./components-tests

      - name: Run OpenMW tests
        working-directory: build
        run: ./openmw-tests

      - name: Run OpenMW-CS tests
        working-directory: build
        run: ./openmw-cs-tests

  MacOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: CI/before_install.macos.sh

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-${{ env.BUILD_TYPE }}-unity
          max-size: 2000M
          verbose: 2

      - name: Configure
        run: CI/before_script.macos.sh -C

      - name: Build
        run: CI/macos/build.sh

  Windows:
    needs: [Output-Envs]
    strategy:
      fail-fast: false # Let both MSVC versions finish even if one fails
      matrix:
        include:
          - image: "2019"
            msvc: "2019"
          - image: "2022"
            msvc: "2022"
    uses: ./.github/workflows/windows.yml
    with:
      image: ${{ matrix.image }}
      msvc: ${{ matrix.msvc }}
      vcpkg-deps-tag: ${{ needs.Output-Envs.outputs.VCPKG_DEPS_TAG }}
      build-type: ${{ needs.Output-Envs.outputs.BUILD_TYPE }}
